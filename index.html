<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
	<title>Title of the document</title>
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<link href="stylesheets/normalize.css" rel="stylesheet" type="text/css"/>
	<link href="stylesheets/battelcode.css" rel="stylesheet" type="text/css"/>
	<script src="lib/three.min.js"></script>
	<script src="lib/stats.min.js"></script>
	<script src="camera.js"></script>
	<script src="modelrenderer.js"></script>
	<script src="teams/teams.js"></script>
</head>
<body>
	<div id="container">
		<div class="controls">
		<input type="file" accept=".rms" onchange="loadFile(this.files[0])" style="top:0px;left:0px;position:absolute;z-index:100">
		</div>
		<div id="textDiv" style="position:absolute;top:0px;text-align:center;z-index:10;width:100%;opacity:0">
			<div id="team1Text" style="display:inline-block;color:red;fon-family:monospace;font-weight:bold"></div>
			<div style="display:inline-block;fon-family:monospace;padding:1rem">VS</div>
			<div id="team2Text" style="display:inline-block;color:blue;fon-family:monospace;font-weight:bold"></div>
		</div>
		<div class="stats">
			<div class="left">
				<ul class="trophies">
					<li></li>
					<li></li>
					<li></li>
				</ul>
				<div class="photo">
					<img src="http://s3.amazonaws.com/battlecode-avatars/avatars/96dbd41482d6f312e3dc52109c062de7.png"/>
				</div>
				<h3>Schnitzel</h3>
				<ul class="towers">
					<li class="alive"></li>
					<li class="alive"></li>
					<li class="dead"></li>
				</ul>
				<div class="live">
				</div>
			</div>
			<div class="right">
				<ul class="trophies">
					<li></li>
					<li></li>
					<li></li>
				</ul>
				<div class="photo">
					<img src="http://s3.amazonaws.com/battlecode-avatars/avatars/472e28e40621ebf0cd25b687a9525d71.png"/>
				</div>
				<h3>Geoduck</h3>
				<ul class="towers">
					<li class="alive"></li>
					<li class="dead"></li>
					<li class="dead"></li>
				</ul>
				<div class="live">
				</div>
			</div>
		</div>
	</div>
</body>
<!-- setup page -->
<script type="text/javascript">
	renderer = new THREE.WebGLRenderer();
	renderer.shadowMapEnabled = true;
	renderer.shadowMapSoft = false;
	renderer.setClearColor( 0xffffff );
	renderer.setPixelRatio( window.devicePixelRatio );
	renderer.setSize( window.innerWidth, window.innerHeight );
	container.appendChild( renderer.domElement );

	stats = new Stats();
	stats.domElement.style.position = 'absolute';
	stats.domElement.style.top = '0px';
	stats.domElement.style.right = '0px';
	stats.domElement.style.zIndex = 100;
	container.appendChild( stats.domElement );
</script>
<!-- worker -->
<script type="text/javascript">
	function loadFile(file){
		if(window.worker)
			window.worker.terminate();
		resetSimulation();
		simulationData.score = [0,0];
		replayData = null;
		currentMap = 0;
		startNewWorker(file);
	}

	function startNewWorker(file){
		window.worker = new Worker('workerbundle.js');
		window.worker.addEventListener('error', function(e){
			console.error([
				'ERROR: Line ', e.lineno, ' in ', e.filename, ': ', e.message
			].join(''));
		}, false);
		// got parsed chunk. render it
		window.worker.addEventListener('message', function(e) {
			var data = e.data;
			if(data.message=='teams'){
				for(var i =0;i<data.data.length;i++)
					data.data[i] = teams[parseInt(data.data[i].substring(4))];
				replayData = {maplist:[],teams:data.data};
				team1Text.innerHTML = data.data[0];
				team2Text.innerHTML = data.data[1];
				textDiv.style.opacity = 1;
			}
			if(data.message=='mapinfo'){
				replayData.maplist.push(data.data);
			}
			if(data.message=='frames'){
				var newFrames = data.data;
				var frames = replayData.maplist[replayData.maplist.length-1].frames;
				for(var i=0;i<newFrames.length;i++)
					frames.push(newFrames[i]);
			}
		}, false);
		window.worker.postMessage(file);
	}
</script>
<!-- simulation & parsing -->
<script type="text/javascript">
	var simulationData  = {
			robots:{},
			lines:[],
			ore:[],
			oreChanged:false,
			ready:false,
			score:[0,0],
			gold:[0,0],
			map:null
		};

        var replayData;
        var currentFrame=0;
        var currentMap=0;

        function resetSimulation(){
            currentFrame = 0;
            simulationData.robots = {};
            simulationData.lines = [];
            simulationData.ore = [];
            simulationData.ready = false;
            simulationData.oreChanged = false;
			simulationData.map = null;
			simulationData.gold = [0,0];
        }

        function maplocToOreLoc(maploc){
            var map = simulationData.map;
            return [-map.originX+maploc[0],-map.originY+maploc[1]];
        }

        function simulate(){
            if(replayData==null || replayData.maplist.length==currentMap || replayData.maplist[currentMap].frames.length<=currentFrame+1)
                return;
            if(currentFrame==0){
                //INITIALIZE MAP & ORE
                var map = replayData.maplist[currentMap];
                var oreStringArray = map.ore.split(',');
                for(var x =0;x<map.width;x++){
                    var row = [];
                    for(var y =0;y<map.height;y++){
                        var currentOre = parseInt(oreStringArray[y+x*map.height]);
                        row.push([currentOre,0,'']);
                    }
                    simulationData.ore.push(row);
                }
                var tiles = map.tiles;
                for(var x =0;x<map.width;x++){
                    for(var y=0;y<map.height;y++){
                        if(x==-1||y==-1||x==map.width||y==map.height||tiles.charAt(x+y*map.width)=='#'){
                            simulationData.ore[x][y][1]=-1;
                        }
                    }
                }
                simulationData.oreChanged = true;
                simulationData.ready = true;
                simulationData.map = map;
            }
            var frame = simulationData.map.frames[currentFrame];
            var sigs = frame.signals;
            simulationData.lines = [];
            simulationData.gold = frame.score;
            currentFrame++;
            for(var i =0;i<sigs.length;i++){
                var sig = sigs[i];
                if(sig.type=="spawn"){
                    var robot = {
                        id:sig.robotID,
                        loc: sig.loc,
                        team: sig.team,
                        type: sig.robotType,
                        lastloc: sig.loc,
                        hasInterp: false,
                        rot:0
                    };
                    simulationData.robots[robot.id] = robot;
                }else if(sig.type=="move"){
                    var robot = simulationData.robots[sig.robotID];
                    robot.lastloc = robot.loc;
                    robot.loc = sig.loc;
                    robot.hasInterp = true;
                }else if(sig.type=="attack"){
                    var robot = simulationData.robots[sig.robotID];
                    simulationData.lines.push([robot,sig.loc]);
                }else if(sig.type=="ore"){
                    var oreLoc = maplocToOreLoc(sig.loc);
                    simulationData.ore[oreLoc[0]][oreLoc[1]][1] = sig.amount;
                    simulationData.oreChanged = true;
                }else if(sig.type=="mine"){
                    var robot = simulationData.robots[sig.robotID];
                    var mineLoc = robot?maplocToOreLoc(robot.loc):maplocToOreLoc(sig.loc);
                    simulationData.ore[mineLoc[0]][mineLoc[1]][2] = robot?robot.team:sig.team;
                    simulationData.oreChanged = true;
                }else if(sig.type=="death"){
                    delete simulationData.robots[sig.robotID];
                }else if(sig.type=="mapend"){
					simulationData.score[(sig.winner=='A')?0:1]++;
					resetSimulation();
					currentMap++;
                } }
        }
    </script>
    <script src="renderer.js"></script>
</html>

