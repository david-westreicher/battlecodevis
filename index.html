<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>battlecodevis - by team schnitzel</title>
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        
        <!-- STYLESHEETS -->
        <link href="dist/main.css" rel="stylesheet" type="text/css"/>
        <!--[if IE 7]><link href="dist/main-ie7.css" rel="stylesheet" type="text/css"/><![endif]-->
        
        <!-- VENDOR LIBS -->
        <link href="vendor/normalize.css/normalize.css" rel="stylesheet" type="text/css"/>
        <script src="vendor/threejs/build/three.js"></script>
        <script src="vendor/stats.js/build/stats.min.js"></script>
        
        <!-- APP -->
        <script src="src/app/helpers.js"></script>
        <script src="src/app/camera.js"></script>
        <script src="src/app/simulation.js"></script>
        <script src="src/app/robottypes.js"></script>
        <script src="src/app/modelrenderer.js"></script>
        <script src="src/app/explosionrenderer.js"></script>
        <script src="src/app/gui.js"></script>
        <script src="src/teams/teams.js"></script>
        
        <!--
           from sewa: i would prefer a require.js setup, with packaged files / classes / objects
           then we can build one distribution file with require.js included
           but the beefy live update doesn't work, so use "npm run server-static"
        -->
        <!--
        <script src="vendor/requirejs/require.js"></script>
        <script src="vendor/jquery/jquery.js"></script>
        <script>
            $(document).ready(function(){
                // init our require app / bootstrap require
                require({
                    baseUrl: './src/',
                    paths: {
                        r: './require.app'
                    },
                    deps: ['r'],
                    urlArgs: "bust=" + (new Date()).getTime()
                });
                
                // boootstraping the app
                require(['r'], function(r)
                {
                    // you can set the url prefix for harder links
                    // window.setUrlPrefix('{{ URL::to("") }}/');
                    
                    // check for readyness
                    r.onReady(function()
                    {
                        /**
                         * SETUP YOUR APP 
                         */
                        require([
                            'bootstrap',
                            'statsjs',
                            'threejs',
                            
                            'helpers',
                            'camera',
                            'simulation',
                            'robottypes',
                            'modelrenderer',
                            'explosionrenderer',
                            'gui',
                            'teams/teams'
                        ], function(Bootstrap, Statsjs, Threejs)
                        {
                            console.log(Bootstrap);
                            console.log(Statsjs);
                            console.log(Threejs);
                        });
                    });
                });
            });
        </script>
        -->
        
    </head>
    <body>
        <div id="container">
            <div class="controls">
            <input type="file" accept=".rms" onchange="loadFile(this.files[0])" style="top:0px;left:0px;position:absolute;z-index:100">
            </div>
            <div class="stats">
                <div class="left">
                    <div class="robots">
                        <div class="commander bar"><span></span></div>
                    </div>
                    <div class="photo">
                        <img src="assets/images/avatar_placeholder.png"/>
                    </div>
                    <h3>???</h3>
                    <ul class="towers bar"></ul>
                    <ul class="trophies bar"></ul>
                    <div class="hq bar"><span></span></div>
                </div>
                <div class="right">
                    <div class="robots">
                        <div class="commander bar"><span></span></div>
                    </div>
                    <div class="photo">
                        <img src="assets/images/avatar_placeholder.png"/>
                    </div>
                    <h3>???</h3>
                    <ul class="towers bar"></ul>
                    <ul class="trophies bar"></ul>
                    <div class="hq bar"><span></span><div>
                </div>
            </div>
        </div>
    </body>
    <script type="text/javascript">
        var constants = {
            HQ: {
                hp: 2000
            },
            COMMANDER: {
                hp: 200
            }
        };
    </script>
    <!-- setup page -->
    <script type="text/javascript">
        //TODO show map name
        //TODO show round number
        renderer = new THREE.WebGLRenderer();
        renderer.shadowMapEnabled = true;
        renderer.shadowMapSoft = false;
        renderer.setClearColor( 0x333333 );
        renderer.setPixelRatio( window.devicePixelRatio );
        renderer.setSize( window.innerWidth, window.innerHeight );
        container.appendChild( renderer.domElement );

        stats = new Stats();
        stats.domElement.style.position = 'absolute';
        stats.domElement.style.top = '0px';
        stats.domElement.style.right = '0px';
        stats.domElement.style.zIndex = 100;
        container.appendChild( stats.domElement );

        var simulation = new Simulation();
    </script>
    <!-- worker -->
    <script type="text/javascript">
        var gui = new GUI();
        function loadFile(file){
            if(!file)
                return;
            if(window.worker)
                window.worker.terminate();
            simulation.newReplayFile();
            replayData = null;
            startNewWorker(file);
            gui.resetWins()
        }

        function startNewWorker(file){
            window.worker = new Worker('workerbundle.js');
            window.worker.addEventListener('error', function(e){
                console.error([
                    'ERROR: Line ', e.lineno, ' in ', e.filename, ': ', e.message
                ].join(''));
            }, false);
            // got parsed chunk. render it
            window.worker.addEventListener('message', function(e) {
                var data = e.data;
                if(data.message=='teams'){
                    for(var i =0;i<data.data.length;i++){
                        var teamArray = teams[parseInt(data.data[i].substring(4))];
                        if(!teamArray)
                            teamArray = [data.data[i],"hq"+(i+1)+".png"];
                        data.data[i] = teamArray;
                    }
                    replayData = {maplist:[],teams:data.data};
                    gui.setTeams(data.data);
                }
                if(data.message=='mapinfo'){
                    replayData.maplist.push(data.data);
                }
                if(data.message=='frames'){
                    var newFrames = data.data;
                    var frames = replayData.maplist[replayData.maplist.length-1].frames;
                    for(var i=0;i<newFrames.length;i++)
                        frames.push(newFrames[i]);
                }
            }, false);
            window.worker.postMessage(file);
        }
    </script>
    <script src="src/app/renderer.js"></script>
</html>

